#!/bin/true

set -e

. lib/env.sh
. lib/functions.sh
. targets/${STRAP_SELECTED_TARGET}.tgt

cd ${STRAP_BUILD_DIR}

extract_source_pkg m4

cd ${STRAP_BUILD_DIR}/m4

sed -i 's/IO_ftrylockfile/IO_EOF_SEEN/' lib/*.c
echo "#define _IO_IN_BACKUP 0x100" >> lib/stdio-impl.h

copy_local_build_stage3

export CHROOT_CD=/build/m4

msg "Configuring m4..."

run_cmd_chroot_stage3 "./configure --prefix=/usr"

msg "Building m4..."

run_cmd_chroot_stage3 "make -j${STRAP_PJOBS}"

msg "Install m4..."

run_cmd_chroot_stage3 "make -j${STRAP_PJOBS} install"