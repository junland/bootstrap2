#/usr/bin/env -S -i bash --norc --noprofile

set -e

. lib/env.sh
. lib/functions.sh
. targets/${STRAP_SELECTED_TARGET}.tgt

[ "${EUID}" -eq "0" ] || msg_fail "build-stage3: Must be run via sudo"

check_target && download_sources && setup_dirs_stage3

STEPS=(root linux-headers)

create_mount_dirs "$STRAP_STAGE3_INSTALL_DIR"

install_qemu_static "$STRAP_STAGE3_INSTALL_DIR"

init_mount_dirs_stage3

for step in ${STEPS[@]} ; do
    clean_build_dir
    msg "Building $step for stage3 targeting $STRAP_SELECTED_TARGET"
    env -S -i STRAP_SELECTED_TARGET="${STRAP_SELECTED_TARGET}" bash --norc --noprofile "stage3/${step}.step" || msg_fail_stage3_term "Building ${step} failed for stage3"
done

term_mount_dirs_stage3

msg "Stage3 complete!"