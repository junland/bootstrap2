#/usr/bin/env -S -i bash --norc --noprofile

set -e

. lib/env.sh
. lib/functions.sh
. targets/${STRAP_SELECTED_TARGET}.tgt

check_target && download_sources && setup_dirs_stage2

STEPS=(root linux-headers)

for step in ${STEPS[@]} ; do
    clean_build_dir
    msg "Building $step for stage2 targeting $STRAP_SELECTED_TARGET"
    env -S -i STRAP_SELECTED_TARGET="${STRAP_SELECTED_TARGET}" bash --norc --noprofile "stage2/${step}.step" || msg_fail "Building ${step} failed for stage2"
done

msg "Stage2 complete!"