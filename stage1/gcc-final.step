#!/bin/true

set -e

. lib/env.sh
. lib/functions.sh
. targets/${STRAP_SELECTED_TARGET}.tgt

cd ${STRAP_BUILD_DIR}

export PATH="$STRAP_STAGE1_INSTALL_DIR/bin:$STRAP_DEFAULT_PATH"

GCC_VER=10.1.0
MPFR_VER=4.1.0
MPC_VER=1.1.0
GMP_VER=6.2.0

unset CC CXX AR AS RANLIB LD STRIP OBJCOPY OBJDUMP

extract_source_pkg gcc
extract_source_pkg mpfr
extract_source_pkg mpc
extract_source_pkg gmp

mkdir -vp ${STRAP_BUILD_DIR}/gcc-${GCC_VER}/{mpfr,mpc,gmp}

mv ${STRAP_BUILD_DIR}/mpfr-${MPFR_VER}/* ${STRAP_BUILD_DIR}/gcc-${GCC_VER}/mpfr
mv ${STRAP_BUILD_DIR}/mpc-${MPC_VER}/* ${STRAP_BUILD_DIR}/gcc-${GCC_VER}/mpc
mv ${STRAP_BUILD_DIR}/gmp-${GMP_VER}/* ${STRAP_BUILD_DIR}/gcc-${GCC_VER}/gmp

cd ${STRAP_BUILD_DIR}/gcc-${GCC_VER}

sed -i 's@\./fixinc\.sh@-c true@' gcc/Makefile.in

#sed -i '/lp64=/s/lib64/lib/' gcc/config/aarch64/t-aarch64-linux
#sed -i '/m64=/s/lib64/lib/' gcc/config/i386/t-linux64

patch -Np1 -i "$STRAP_PATCHES_DIR"/gcc-enable-cet-in-cross.patch
patch -Np1 -i "$STRAP_PATCHES_DIR"/pure-64-bit.patch

mkdir -p ${STRAP_BUILD_DIR}/gcc-build

cd ${STRAP_BUILD_DIR}/gcc-build

unset CC CXX AR AS RANLIB LD STRIP OBJCOPY OBJDUMP

msg "Configuring gcc-final..."

../gcc-${GCC_VER}/configure AR=ar LDFLAGS="-Wl,-rpath,$STRAP_STAGE1_INSTALL_DIR/lib " \
    --prefix=${STRAP_STAGE1_INSTALL_DIR} \
    --libdir="$STRAP_STAGE1_INSTALL_DIR/lib" \
	--libexecdir="$STRAP_STAGE1_INSTALL_DIR/lib" \
    --build=$STRAP_HOST \
    --host=$STRAP_HOST \
    --target=$STRAP_TARGET \
    --with-sysroot=$STRAP_STAGE1_INSTALL_DIR/sysroot \
    --enable-languages=c,c++ \
    --enable-shared \
    --enable-threads \
    --disable-werror \
	--disable-multilib \
    --without-isl \
    $STRAP_TARGET_GCCOPTS

msg "Building gcc-final..."

make -j${STRAP_PJOBS} all -C ${STRAP_BUILD_DIR}/gcc-build

msg "Installing gcc-final..."

make -j${STRAP_PJOBS} install