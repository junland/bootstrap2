#!/bin/true
GLIBC_VER=2.31

set -e

. lib/env.sh
. lib/functions.sh
. targets/${STRAP_SELECTED_TARGET}.tgt

cd ${STRAP_BUILD_DIR}

export PATH="$STRAP_STAGE1_INSTALL_DIR/bin:$STRAP_DEFAULT_PATH"

export BUILD_CC="gcc"
export CC="$STRAP_TARGET-gcc"
export CXX="$STRAP_TARGET-g++"
export AR="$STRAP_TARGET-ar"
export AS="$STRAP_TARGET-as"
export RANLIB="$STRAP_TARGET-ranlib"
export LD="$STRAP_TARGET-ld"
export STRIP="$STRAP_TARGET-strip"
export OBJCOPY="$STRAP_TARGET-objcopy"
export OBJDUMP="$STRAP_TARGET-objdump"

extract_source_pkg glibc

mkdir -p ${STRAP_BUILD_DIR}/glibc-build

cd ${STRAP_BUILD_DIR}/glibc-build

echo "libc_cv_forced_unwind=yes" > $STRAP_BUILD_DIR/glibc-build/configparms
echo "libc_cv_c_cleanup=yes" >> $STRAP_BUILD_DIR/glibc-build/configparms
echo "libc_cv_ssp=no" >> $STRAP_BUILD_DIR/glibc-build/configparms
echo "libc_cv_ssp_strong=no" >> $STRAP_BUILD_DIR/glibc-build/configparms
echo "slibdir=/usr/lib" >> $STRAP_BUILD_DIR/glibc-build/configparms
echo "rtlddir=/usr/lib" >> $STRAP_BUILD_DIR/glibc-build/configparms

msg "Configuring glibc..."

../glibc-${GLIBC_VER}/configure CFLAGS="-O2 " CPPFLAGS="" CXXFLAGS="-O2 " LDFLAGS="" \
    --prefix=/usr \
    --target=$STRAP_TARGET \
    --build=$STRAP_HOST \
    --host=$STRAP_TARGET \
    --with-headers=${STRAP_STAGE1_INSTALL_DIR}/sysroot/usr/include \
    --libdir=/usr/lib \
    --libexecdir=/usr/lib \
    --enable-shared \
    --disable-profile \
    --without-cvs \
    --without-gd \
    --cache-file=$STRAP_BUILD_DIR/glibc-build/configparms
    --disable-werror

msg "Building glibc..."

make -j${STRAP_PJOBS} all

msg "Installing glibc..."

make -j${STRAP_PJOBS} install_root=${STRAP_STAGE1_INSTALL_DIR}/sysroot install 
